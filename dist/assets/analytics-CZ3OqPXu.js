const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/supabase-CAbq-tO9.js","assets/preload-helper-CS1eXPs2.js"])))=>i.map(i=>d[i]);
import{_ as c}from"./preload-helper-CS1eXPs2.js";let i=null,o=!1;async function d(){if(i!==null)return o;try{return i=(await c(()=>import("./supabase-CAbq-tO9.js"),__vite__mapDeps([0,1]))).supabase,o=!0,console.log("✅ Analytics: Supabase连接已建立"),!0}catch(n){return console.warn("⚠️ Analytics: Supabase连接失败，分析功能将在静默模式下运行:",n.message),i=null,o=!1,!1}}let t=[],a=null,l=!1;function u(){let n=localStorage.getItem("joypark_user_id");return n||(n=crypto.randomUUID(),localStorage.setItem("joypark_user_id",n)),n}async function r(){if(t.length===0||l)return;if(!await d()){console.log("📊 Analytics: Supabase不可用，丢弃 "+t.length+" 个事件"),t=[];return}l=!0;const s=[...t];t=[],clearTimeout(a),a=null;try{if(!navigator.onLine){console.warn("📊 Analytics: 网络离线，分析事件将在网络恢复后发送"),t.unshift(...s);return}const{error:e}=await i.from("analytics_events").insert(s);e?(console.warn("📊 Analytics Batch Error:",e),e.message&&(e.message.includes("fetch")||e.message.includes("network"))&&(console.warn("📊 Analytics: 网络错误，事件将重新加入队列"),t.unshift(...s))):console.log(`📊 Analytics: 成功发送 ${s.length} 个分析事件`)}catch(e){console.warn("📊 Analytics: 发送失败:",e.message),(e.name==="AbortError"||e.message.includes("fetch"))&&(console.warn("📊 Analytics: 网络请求失败，事件将重新加入队列"),t.unshift(...s))}finally{l=!1}}window.addEventListener("beforeunload",()=>{if(t.length>0&&navigator.sendBeacon){const n=u(),s=t.map(e=>({...e,user_id:n}));try{navigator.sendBeacon("/api/analytics",JSON.stringify(s))}catch{r()}}});document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&r()});function y(n,s={}){try{const e=u();t.push({user_id:e,event_type:n,event_data:s}),console.log(`📊 Analytics: 追踪事件 ${n}`,s),a&&clearTimeout(a),a=setTimeout(r,3e3),t.length>=10&&r()}catch(e){console.warn("📊 Analytics: 追踪事件失败:",e.message)}}function g(){return r()}function m(){return u()}export{g as flushAnalytics,m as getDebugUserId,y as trackEvent};
